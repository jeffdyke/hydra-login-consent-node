
name: hydra
volumes:
  postgres-data:

services:
  hydra-migrate:
    image: oryd/hydra:v2.2.0
    environment:
      - DSN=postgres://hydra:my-super-secret-password@postgres:5432/hydra?sslmode=disable
    command: migrate sql -e --yes
    restart: on-failure
    depends_on:
      - postgres
    networks:
      - hydra-net

  hydra:
    image: oryd/hydra:v2.2.0
    ports:
      - "4444:4444" # Public API
      - "4445:4445" # Admin API
    logging:
      driver: json-file
      options:
        tag: hydra
    command: serve all --dev --config /etc/hydra-headless-ts/hydra.yml
    environment:
      # If this changes and the application is using it, the database will need to be rebuilt
      - SECRETS_SYSTEM=G6KaOf8aJsLagw566he8yxOTTO3tInKD
      - DSN=postgres://hydra:my-super-secret-password@postgres:5432/hydra?sslmode=disable
    # build:
    #   context: .
    #   dockerfile: Dockerfile.hydra
    restart: unless-stopped
    volumes:
      - /var/log/hydra-headless-ts:/var/log/hydra-headless-ts
      - /etc/hydra-headless-ts:/etc/hydra-headless-ts:ro
    depends_on:
      - hydra-migrate
    networks:
      - hydra-net
  postgres:
    image: postgres:18-alpine
    environment:
      - POSTGRES_USER=hydra
      - POSTGRES_PASSWORD=my-super-secret-password
      - POSTGRES_DB=hydra
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init-session-table.sql:/docker-entrypoint-initdb.d/01-init-session-table.sql:ro
    networks:
      - hydra-net
    ports:
      - "5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hydra -d hydra"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  redis:
    image: redis
    ports:
      - 16379:6379
    networks:
      - hydra-net
  headless-ts:
    image: jeffdyke/hydra-headless-ts:latest
    env_file:
      - /etc/hydra-headless-ts/.env.auth.hydra
      - /etc/hydra-headless-ts/.env.auth.google
    ports:
      - "3000:3000"
    build:
      context: .
      dockerfile: build/Dockerfile.headless-ts
    environment:
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - NODE_ENV=development
    depends_on:
      - hydra
    networks:
      - hydra-net
    restart: unless-stopped
    volumes:
      - /var/log/hydra-headless-ts:/var/log/hydra-headless-ts
      - /etc/hydra-headless-ts:/etc/hydra-headless-ts:ro

networks:
  hydra-net:
    driver: bridge
