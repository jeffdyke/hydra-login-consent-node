
name: hydra
volumes:
  postgres-data:

services:
  hydra-migrate:
    image: oryd/hydra:v2.2.0
    environment:
      - DSN=postgres://hydra:shaken!stirred@postgres:5432/hydra?sslmode=disable
    command: migrate sql -e --yes
    restart: on-failure
    depends_on:
      - postgres
    networks:
      - hydra-net

  hydra:
    image: oryd/hydra:v2.2.0
    ports:
      - "4444:4444" # Public API
      - "4445:4445" # Admin API
    command: serve all --dev --config /etc/bondlink/hydra/hydra.yml
    # env_file:
    #   - /etc/bondlink/hydra/.env
    #   - /etc/bondlink/hydra/.env.auth.hydra
    #   - /etc/bondlink/hydra/.env.auth.google
    environment:
      #TODO: These should be moved to perm locations, as they should never change, or
      # database must be rebuilt
      - SECRETS_SYSTEM=G6KaOf8aJsLagw566he8yxOTTO3tInKD
      - OIDC_SUBJECT_IDENTIFIERS_PAIRWISE_SALT=1AvfImNiD7yPGE7LYBcT5hJXOzydEEW1
      - DSN=postgres://hydra:shaken!stirred@postgres:5432/hydra?sslmode=disable
    build:
      context: .
      dockerfile: Dockerfile.hydra
    restart: unless-stopped
    volumes:
      - /var/log/bondlink/hydra:/var/log/bondlink/hydra
      - /etc/bondlink/hydra:/etc/bondlink/hydra
    depends_on:
      - hydra-migrate
    networks:
      - hydra-net

  postgres:
    image: postgres:18-alpine
    environment:
      - POSTGRES_USER=hydra
      - POSTGRES_PASSWORD=shaken!stirred
      - POSTGRES_DB=hydra
    volumes:
      - postgres-data:/var/lib/postgres/data
    networks:
      - hydra-net
    ports:
      - "5432:5432"
    restart: unless-stopped

  consent-app:
    image: 668874212870.dkr.ecr.us-east-1.amazonaws.com/drone-hydra-consent-node
    env_file:
      - /etc/bondlink/hydra/.env
      - /etc/bondlink/hydra/.env.auth.hydra
      - /etc/bondlink/hydra/.env.auth.google
    ports:
      - "3000:3000"
    build:
      context: .
      dockerfile: build/Dockerfile.consent-app
    environment:
      - HYDRA_ADMIN_URL=http://0.0.0.0:4445
      - HYDRA_REDIRECT_URI=http://auth.staging.bondlink.org/callback
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - NODE_ENV=development
    depends_on:
      - hydra
    networks:
      - hydra-net
    restart: unless-stopped
    volumes:
      - /var/log/bondlink/hydra:/var/log/bondlink/hydra

networks:
  hydra-net:
    driver: bridge
